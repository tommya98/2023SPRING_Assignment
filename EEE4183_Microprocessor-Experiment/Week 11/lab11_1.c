#include <stm32f10x.h>
#define DOT_MATRIX_COL 0x4001100C

u8 font8x8[16][8] = {
  {0x3c, 0x42, 0x46, 0x4a, 0x52, 0x62, 0x3c, 0x00}, //0
  {0x10, 0x30, 0x50, 0x10, 0x10, 0x10, 0x7c, 0x00}, //1
  {0x3c, 0x42, 0x02, 0x0c, 0x30, 0x42, 0x7e, 0x00}, //2
  {0x3c, 0x42, 0x02, 0x1c, 0x02, 0x42, 0x3c, 0x00}, //3
  {0x08, 0x18, 0x28, 0x48, 0xf3, 0x08, 0x1c, 0x00}, //4
  {0x7e, 0x40, 0x7c, 0x02, 0x02, 0x42, 0x3c, 0x00}, //5 
  {0x1c, 0x20, 0x40, 0x7c, 0x42, 0x42, 0x3c, 0x00}, //6
  {0x7e, 0x42, 0x04, 0x08, 0x10, 0x10, 0x10, 0x00}, //7
  {0x3c, 0x42, 0x42, 0x3c, 0x42, 0x42, 0x3c, 0x00}, //8
  {0x3c, 0x42, 0x42, 0x3e, 0x02, 0x04, 0x38, 0x00}, //9
  {0x18, 0x24, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x00}, //A
  {0x7c, 0x22, 0x22, 0x3c, 0x22, 0x22, 0x7c, 0x00}, //B
  {0x1c, 0x22, 0x40, 0x40, 0x40, 0x22, 0x1c, 0x00}, //C
  {0x78, 0x24, 0x22, 0x22, 0x22, 0x24, 0x78, 0x00}, //D
  {0x7e, 0x22, 0x28, 0x38, 0x28, 0x22, 0x7e, 0x00}, //E
  {0x7e, 0x22, 0x28, 0x38, 0x28, 0x20, 0x70, 0x00}, //F
};

u8 data = 0x09;
u32 row = 1;

int main(void) {
  RCC->APB2ENR |= 0x0000001D;
  GPIOC->CRL = 0x33333333;
  GPIOB->CRH = 0x33333333;

  RCC->APB1ENR |= 0x00000001;
  TIM2->CR1 = 0x04;
  TIM2->CR2 = 0x00;
  TIM2->PSC = 0x07EF;
  TIM2->ARR = 0x000F;
  TIM2->DIER = 0x0101;
  NVIC->ISER[0] = (1 << 28);

  RCC->AHBENR |= 0x00000001;
  DMA1_Channel2->CCR = 0x000000B0;
  DMA1_Channel2->CNDTR = 8;
  DMA1_Channel2->CPAR = DOT_MATRIX_COL;
  DMA1_Channel2->CMAR = (u32) font8x8[data];

  DMA1_Channel2->CCR |= 0x00000001;

  TIM2->CR1 |= 0x0001;
  
  while(1) {;}

} // end main

void TIM2_IRQHandler(void) {
  if((TIM2->SR & 0x0001) != 0) {
    GPIOB->ODR = (~row) << 8;
    row = row << 1;
    if(row == 0x100) {row = 1;}
    TIM2->SR &= ~(1 << 0); //clear UIF
  }
}