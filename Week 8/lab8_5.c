#include <stm32f10x.h>

void keyboard(void);

u32 i, key_index, key_row, key_col, col_scan, new_button, old_button, ch, dot_row, dot_col, j = 0, k;

u32 font[26][8] = {
  {0x18, 0x24, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x00},
  {0x7c, 0x22, 0x22, 0x3c, 0x22, 0x22, 0x7c, 0x00}, 
  {0x18,0x24,0x40,0x40,0x40,0x40,0x24,0x18},
  {0x78,0x44,0x42,0x42,0x42,0x42,0x44,0x78},
  {0x7E,0x40,0x40,0x7E,0x40,0x40,0x40,0x7E},
  {0x7E,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},
  {0x18,0x24,0x40,0x40,0x46,0x42,0x24,0x18},
  {0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42},
  {0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08},
  {0x02,0x02,0x02,0x02,0x02,0x42,0x24,0x18},
  {0x44,0x48,0x50,0x60,0x50,0x48,0x44,0x42},
  {0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7E},
  {0x66,0x5A,0x5A,0x5A,0x5A,0x5A,0x42,0x42},
  {0x42,0x62,0x52,0x52,0x4A,0x4A,0x46,0x42},
  {0x18,0x24,0x42,0x42,0x42,0x42,0x24,0x18},
  {0x7C,0x42,0x42,0x42,0x7C,0x40,0x40,0x40},
  {0x18,0x24,0x42,0x42,0x42,0x4E,0x26,0x1A},
  {0x7C,0x42,0x42,0x42,0x7C,0x48,0x44,0x42},
  {0x3C,0x42,0x40,0x20,0x1C,0x02,0x02,0x3C},
  {0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08},
  {0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},
  {0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},
  {0x44,0x44,0x54,0x54,0x54,0x28,0x28,0x28},
  {0x42,0x24,0x18,0x18,0x18,0x24,0x42,0x42},
  {0x44,0x44,0x44,0x28,0x10,0x10,0x10,0x10},
  {0x7E,0x02,0x04,0x08,0x10,0x20,0x40,0x7E}
};

int main(void) {

  RCC->APB2ENR = 0x0000001D;

  GPIOC->CRH = 0x00003333;
  GPIOA->CRH = 0x00008888;
  GPIOA->ODR = 0x0F00;

  GPIOC->CRL = 0x33333333;
  GPIOB->CRH = 0x33333333;

  dot_row = 0x0001;
  dot_col = 0x0000;

  key_index = 0;
  key_row = 0x01;

  while(1) {
    GPIOC->BSRR = (~(key_row << 8) & 0x0F00) | (key_row << 24);
    for(i = 0; i < 1000; i++) { ; }
    key_col = GPIOA->IDR;
    key_col = (key_col >> 8) & 0x0F;
    col_scan = 0x01;
    for (i = 0; i < 4; i++) {
      if((key_col & col_scan) == 0) {
        for(k = 0; k <300000; k++);
				new_button = key_index;
				keyboard();
			}
      col_scan = col_scan << 1;
      key_index = key_index + 1;
    }
    key_row = key_row << 1;
    if (key_row == 0x10) {
      key_row = 0x01;
      key_index = 0;
    }

    GPIOC->ODR = ~dot_row;
	  dot_row = dot_row << 1;
	  dot_col = font[ch - 'a'][j++];
	  GPIOB->ODR = dot_col << 8;
	  if(dot_row == 0x0100) {
		  dot_row = 0x0001;
		  j = 0;
	  }
  }
}

void keyboard(void) {
	if(new_button == old_button) {
    switch(new_button) {
      case 8: //2: abc
        if(ch != 'c') {
          ch++;
        }
        break;
      case 4: //3: def
        if(ch != 'f') {
          ch++;
        }
        break;
      case 13: //4: ghi
        if(ch != 'i') {
          ch++;
        }
        break;
      case 9: //5: jkl
        if(ch != 'l') {
          ch++;
        }
        break;
      case 5: //6: mno
        if(ch != 'o') {
          ch++;
        }
        break;
      case 14: //7: pqrt
        if(ch != 't') {
          ch++;
        }
        break;
      case 10: //8: tuv
        if(ch != 'v') {
          ch++;
        }
        break;
      case 6: //9: wxyz
        if(ch != 'z') {
          ch++;
        }
        break;
      default:
        return;
    }
  }
  else if(new_button != 9999){
    switch(new_button) {
      case 8: //2: abc
        ch = 'a';
        break;
      case 4: //3: def
        ch = 'd';
        break;
      case 13: //4: ghi
        ch = 'g';
        break;
      case 9: //5: jkl
        ch = 'j';
        break;
      case 5: //6: mno
        ch = 'm';
        break;
      case 14: //7: pqrt
        ch = 'p';
        break;
      case 10: //8: tuv
        ch = 't';
        break;
      case 6: //9: wxyz
        ch = 'w';
        break;
      case 3: //enter
        break;
      default:
        return;
    }
  if(new_button != 9999) {
		old_button = new_button;
	}
		new_button = 9999;
  }
}
